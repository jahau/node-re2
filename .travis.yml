sudo: false

branches:
  only:
    - master

language: node_js
node_js:
  - 10

os:
  - osx
  - linux
  - windows
osx_image: xcode9.2

services: docker

install:
  - >
    PACKAGE_VERSION=$(cat package.json | grep version | head -1 | awk -F: '{ print $2 }' | sed 's/[\",]//g' | tr -d '[[:space:]]')
  - echo "Building archives for $PACKAGE_VERSION"
  - mkdir -p ./target/
  - if [ "$TRAVIS_OS_NAME" = "linux" ]; then export ARCHIVE_PLATFORM=linux; build-resources/linux/build.sh; fi
  - if [ "$TRAVIS_OS_NAME" = "osx" ]; then export ARCHIVE_PLATFORM=darwin; npm install; cp ./build/Release/re2.node ./target/; fi
  - if [ "$TRAVIS_OS_NAME" = "windows" ]; then export ARCHIVE_PLATFORM=windows; npm install; cp ./build/Release/re2.node ./target/; fi
  - mkdir -p ./archives/
  - tar czvf "./archives/$PACKAGE_VERSION-$ARCHIVE_PLATFORM.tar.gz" ./target/re2.node
script:
  - echo "skipping tests"

deploy:
  provider: s3
  access_key_id: "YOUR AWS ACCESS KEY"
  secret_access_key: "YOUR AWS SECRET KEY"
  bucket: "kbn-native-modules"
  local_dir: ./archives/
  upload_dir: re2
  acl: public_read
  skip_cleanup: true
  edge: true
